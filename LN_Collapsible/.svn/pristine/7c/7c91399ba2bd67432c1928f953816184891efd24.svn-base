define(["ojs/ojcore","jquery","ojs/ojdatacollection-common","ojs/ojmodel"],function(a){a.wa=function(f){f=f||{};this.Ho=f.root;this.EU=f.childCollectionCallback;this.El=f.parseMetadata;this.Yj=null;this.Ml="none";this.Ac={};a.wa.t.constructor.call(this)};o_("CollectionTreeDataSource",a.wa,a);a.wa.prototype.El=function(a){return{key:a.idAttribute+"\x3d"+a.id}};a.b.qa(a.wa,a.vc,"oj.CollectionTreeDataSource");a.wa.prototype.Init=function(){a.wa.t.Init.call(this)};a.b.g("CollectionTreeDataSource.prototype.Init",
{Init:a.wa.prototype.Init});a.wa.prototype.Je=function(a){var c=this.Ac[a];if(c&&0<c.length)return c.length;this.ox(a,{success:function(a){return a.length}});return-1};a.b.g("CollectionTreeDataSource.prototype.getChildCount",{Je:a.wa.prototype.Je});a.wa.prototype.ox=function(a,c){this.Ud(a,null,{success:function(a){c.success(a.na)},error:c.error})};a.b.g("CollectionTreeDataSource.prototype.getChildCollection",{ox:a.wa.prototype.ox});a.wa.prototype.Ud=function(a,c,b){c=c||{};var d=c.start?c.start:
0,e=c.count?c.count:-1;if(null===a)this.Rl(null,d,e,b,null);else{var g=this;this.Su(this.Ho,a,0).then(function(c){c?(c=g.To(c.Ao),g.Rl(c,d,e,b,a)):b&&b.error&&b.error(a)})}};a.b.g("CollectionTreeDataSource.prototype.fetchChildren",{Ud:a.wa.prototype.Ud});a.wa.prototype.qJ=function(a,c,b){var d=0;b&&b.at&&(d=b.at);a=this.Pp(this,"insert",d,this.rq(c),this.sE(a));this.handleEvent("insert",a)};a.wa.prototype.rJ=function(a,c,b){var d=0;b&&b.index&&(d=b.index);this.zS(a);a=this.Pp(this,"delete",d,this.rq(c),
null);this.handleEvent("delete",a)};a.wa.prototype.sJ=function(a){var c=this.zO(a),b=null,d=null;c&&(b=c.index,d=this.rq(c.na));a=this.Pp(this,"update",b,d,this.sE(a));this.handleEvent("update",a)};a.wa.prototype.dJ=function(a){a=this.Pp(this,"refresh",null,this.rq(a),null);this.handleEvent("refresh",a)};a.wa.prototype.sE=function(f){var c=[];c.push(f.attributes);var b={};b.idAttribute=f.idAttribute;f=new a.$(c,b);f.fetch();return f};a.wa.prototype.rq=function(f){var c=[],b=null;do b=this.gP(f),null!==
b&&(b!==a.wa.Ky&&c.unshift(b),f=this.AO(b));while(null!=b);return c};a.wa.Ky="%!@ROOT%#@!";a.wa.prototype.iq=function(f){var c=f instanceof a.q?this.El(f).key:f;return f?c:a.wa.Ky};a.wa.prototype.$z=function(a){return this.Ac[this.iq(a)]};a.wa.prototype.sF=function(f,c){c.on(a.X.v.ADD,this.qJ,this);c.on(a.X.v.REMOVE,this.rJ,this);c.on(a.X.v.CHANGE,this.sJ,this);c.on(a.X.v.SYNC,this.dJ,this);this.Ac[this.iq(f)]=c};a.wa.prototype.zS=function(a){a=this.iq(a);for(var c in this.Ac)if(this.Ac.hasOwnProperty(c)&&
c===a){this.Ac[a].off(null,null,this);delete this.Ac[a];break}};a.wa.prototype.$Q=function(a,c){for(var b=c.length,d=0;d<b;d++){var e=this.iq(c.at(d));if(a===e)return!0}return!1};a.wa.prototype.zO=function(a){for(var c in this.Ac)if(this.Ac.hasOwnProperty(c))for(var b=this.Ac[c],d=0;d<b.length;d++)if(b.at(d)===a)return{index:d,na:b};return null};a.wa.prototype.AO=function(a){for(var c in this.Ac)if(this.Ac.hasOwnProperty(c)){var b=this.Ac[c];if(this.$Q(a,b))return b}return null};a.wa.prototype.gP=
function(a){for(var c in this.Ac)if(this.Ac.hasOwnProperty(c)&&this.Ac[c]===a)return c;return null};a.wa.prototype.To=function(a){var c=!0,b=this.$z(a);b||(c=!1,b=this.EU(this.Ho,a),null!=b&&(this.pA(b),this.sF(a,b)));return{na:b,Xw:c}};a.wa.prototype.Pp=function(a,c,b,d,e){return{source:a,operation:c,index:b,parent:d,data:e}};a.wa.prototype.Rl=function(a,c,b,d,e){var g=this;null===a&&((a=this.$z(null))?a={na:a,Xw:!0}:(a={na:g.Ho,Xw:!1},g.sF(null,this.Ho)));a&&g.GB(a,function(a){d.success&&d.success(g.$O(a,
e,c,b))},d.error)};a.wa.prototype.$O=function(f,c,b,d){return new a.Kc(c,f,this,b,d)};a.wa.prototype.$S=function(f,c){var b=this;return a.b.ma(function(a){function e(c,f,k){c<f.length?f.at(c,{deferred:!0}).then(function(l){if(l){var m=b.El(l);if(k===m.key){a(l);return}}c++;e(c,f,k)}):a(null)}e(0,f,c)})};a.wa.prototype.Su=function(f,c,b){var d=this;return a.b.ma(function(a){d.$S(f,c).then(function(g){function h(d,g){if(d<k){var n=g.To(f.at(d));n.na?g.GB(n,function(f){g.Su(f,c,b+1).then(function(b){b?
a(b):(d++,h(d,g))})},null):(d++,h(d,g))}else a(null)}if(g)a({Ao:g,depth:b});else{var k=f.length;h(0,d)}})})};a.wa.prototype.GB=function(a,c,b){a.Xw?c(a.na):(this.Yj&&"none"!==this.Yj&&(a.na.jf=this.Yj,a.na.Ll=this.Ml),0<a.na.length?c(a.na):a.na.fetch({success:function(a){c(a)},error:b}))};a.wa.prototype.wh=function(a,c){var b=this;null===a?this.Rl(null,0,-1,{success:function(a){a.xy({success:function(){c.success&&c.success(a)}})}},null):this.Su(this.Ho,a,0).then(function(d){d&&(d=b.To(d.Ao),b.Rl(d,
0,-1,{success:function(a){a.xy({success:function(){c.success&&c.success(a)}})}},a))})};a.b.g("CollectionTreeDataSource.prototype.fetchDescendants",{wh:a.wa.prototype.wh});a.wa.prototype.sort=function(a,c){var b=a.key,d=a.direction,e=!1;b!==this.Yj&&(this.Yj=b,e=!0);d!==this.Ml&&(this.Ml=d,e=!0);if(e){"none"===this.Ml&&(this.Ac={});for(var g in this.Ac)this.Ac.hasOwnProperty(g)&&this.pA(this.Ac[g])}c&&c.success&&c.success()};a.b.g("CollectionTreeDataSource.prototype.sort",{sort:a.wa.prototype.sort});
a.wa.prototype.pA=function(a){a.comparator=this.Yj;a.sortDirection="ascending"===this.Ml?1:-1;a.sort()};a.wa.prototype.fo=function(){return{key:this.Yj,direction:this.Ml}};a.b.g("CollectionTreeDataSource.prototype.getSortCriteria",{fo:a.wa.prototype.fo});a.wa.prototype.move=function(){a.i.da()};a.b.g("CollectionTreeDataSource.prototype.move",{move:a.wa.prototype.move});a.wa.prototype.Ii=function(){return"invalid"};a.b.g("CollectionTreeDataSource.prototype.moveOK",{Ii:a.wa.prototype.Ii});a.wa.prototype.getCapability=
function(a){return"sort"===a?"default":"move"===a?"none":"batchFetch"===a||"fetchDescendants"===a?"disable":null};a.b.g("CollectionTreeDataSource.prototype.getCapability",{getCapability:a.wa.prototype.getCapability});a.Kc=function(a,c,b,d,e){this.js=a;this.na=c;this.bx=[];this.No=b;this.start=d<c.length?d:c.length-1;this.count=-1===e?c.length:Math.min(c.length,e)};o_("CollectionNodeSet",a.Kc,a);a.Kc.prototype.xy=function(a){this.JB(this).then(function(){a.success&&a.success()})};a.Kc.prototype.JB=
function(f){return a.b.ma(function(a){function b(e){e<d?f.iJ(e,{success:function(a){null!==a?f.JB(a).then(function(){b(e+1)}):b(e+1)}}):a()}var d=f.Z();b(0)})};a.Kc.prototype.iJ=function(a,c){var b=this.na.at(a);if(this.No.El(b).leaf)this.bx[a]=null,c.success(null);else{var d=this.No.To(b),b=this.No.El(b).key,e=this;this.No.Rl(d,0,-1,{success:function(b){e.bx[a]=b;c.success(b)}},b)}};a.Kc.prototype.getParent=function(){return this.js};a.b.g("CollectionNodeSet.prototype.getParent",{getParent:a.Kc.prototype.getParent});
a.Kc.prototype.Ga=function(){return this.start};a.b.g("CollectionNodeSet.prototype.getStart",{Ga:a.Kc.prototype.Ga});a.Kc.prototype.Z=function(){return this.count};a.b.g("CollectionNodeSet.prototype.getCount",{Z:a.Kc.prototype.Z});a.Kc.prototype.getData=function(a){this.Nt(a);return this.na.at(a).attributes};a.b.g("CollectionNodeSet.prototype.getData",{getData:a.Kc.prototype.getData});a.Kc.prototype.Nt=function(a){if(a<this.start||a>this.start+this.count)throw"Out of range";};a.Kc.prototype.getMetadata=
function(a){this.Nt(a);var c={};a=this.na.at(a);a=this.No.El(a);c.key=a.key;c.leaf=a.leaf;c.depth=a.depth;return c};a.b.g("CollectionNodeSet.prototype.getMetadata",{getMetadata:a.Kc.prototype.getMetadata});a.Kc.prototype.Fd=function(a){this.Nt(a);return this.bx[a]};a.b.g("CollectionNodeSet.prototype.getChildNodeSet",{Fd:a.Kc.prototype.Fd})});
//# sourceMappingURL=oj-modular.map